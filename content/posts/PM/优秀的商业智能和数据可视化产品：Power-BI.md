---
title: "优秀的商业智能和数据可视化产品：Power BI"
categories: [PM]
tags: ["BI","数据可视化"]
draft: false
slug: "powerbi"
date: "2020-03-19 14:08:00"
---

[Power BI](https://powerbi.microsoft.com/) 是 Microsoft 出品的一套商业智能体系（包括软件，工具，服务等），可用来构建从个人到中大型企业组织的商业智能平台，便于产品、运营、数据分析师等用户探索和分析数据。

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iiq5wig5j20n0075gmb.jpg)

和 Tableau 一样，Power BI 也支持非常丰富的数据源，接入数据源后也可以快速实现数据可视化及分析探索；同时，Power BI 也在 Gartner 分析和商业智能魔力象限中被评为领导者，BI(商业智能)和可视化方面十分优秀。

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h3ijkw5ca5j20ny0ewjt1.jpg)


## PowerBI运行逻辑 

PowerBI 整体的运行逻辑是先把数据源按指标场景「筛选」数据、生成「度量值」后，把度量值作为生成图表的「上下文」及依据。

这个过程涉及几个核心的模块：**数据建模、筛选器、度量值。**

<img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie108jlj20sj0o10uv.jpg" width="500px">

## 数据建模

利用 SQL 的思维去看 PowerBI 有助于我们理解它的运行逻辑，尤其是在数据建模阶段。

我们在使用数据库的时候，经常需要通过 Join 方法把不同表格的数据连接起来，用于实现多字段的数据提取及不同维度的计算，但在 PowerBI 并不需要这么麻烦，它是通过数据建模来解决这个问题的。

在 PowerBI 中，数据建模的重要性就好比透视表之于 Excel，因为如果没处理好它，后续的度量值、切片器等工具都会出问题，更不用说计算结果了。

### 什么是数据建模

数据建模是分析的基础，从形式上看，数据建模就是把多个表格关联起来。但它的实际内涵不至于此，我们可以借用 Excel 里的数据透视表来理解数据建模：

为了更好地理解，我们先回归到 **数据分析的底层逻辑：报表分析 =分类维度x事实指标。**

比如业务提数据需求说：要按月看不同品类的销售额。

在这个需求中，业务要看的 **事实指标** 是 销售额，其余描述该指标的"形容词"就是 **分类维度：** 按月(时间日期分类)、不同品类(商品品类分类)。

更直观地从 Excel 透视表来看，行、列标签就是需要透视的维度，表格中的值则是按公式计算的事实指标：

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie1sdl4j20pu0matbd.jpg)

**基于该分析逻辑，从应用分析层反推到表格层面，可以把表分为维度表与事实表。** 在具体使用时，只需要从维度表中选择需要透视（分析）的维度，再从事实表计算指标即可完成报表分析。

这个数据建模类型，有一个更专业的名字：维度建模。

比如上图的案例是计算每个月不同产品分类的销售额：订单表就是事实表，产品规格、产品表、日期表就是维度表；为了能实现上表的计算需要把事实表和维度表建立关系，这个建立关系的过程，就是数据建模。

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie2ytn4j20qx0mdwfn.jpg)

如图，订单表与产品规格表，通过字段sku连接起来; 产品表和产品规格表通过字段spu连接起来。

## 关系

数据库表连接中，重要的是不同连接方法，那接下来就谈谈 PowerBI 数据建模中的 **表间「关系」** 。

首先要注意，用户创建关系的列，必须是一样的，且只能通过一个字段连接。

### 关系的类型

概括来说，数据模型中共有三种关系

1. 多对一、一对多：比如学生和校长之间就是多对一的关系，一个学校有多个学生，但只有一个校长。**这是数据建模中最为常见且建议使用的关系类型。**
2. 一对一：比如班级和班主任就是一对一的关系，每个班有且只有一个班主任，每个班主任也只带一个班。
3. 多对多：比如学生和任课老师的关系，每个学生有多个科目的老师，每个老师向多个学生教授知识。**一般情况下不建议采用这种关系，因为多对多筛选会很容易导致筛选混乱，且性能较差。**

遇到多对多关系时，一般的解决方案就是拆表：在两个表中间插入多一个中间表。比如学生和任课老师之间，插入学校表：多个学生对应一个学校，一个学校对应多个任课老师。

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie4ccsnj20te0p20v8.jpg)

### 关系链

关系有一个重要属性，那就是关系可以形成链条，比如上图案例中，订单表中记录的商品是到 SKU 级别，所以订单表和产品规格表通过 SKU 建立关系，而多个 SKU 可能对应一个 SPU，所以产品规格表和产品表通过 SPU 建立关系。

当我们要从 SPU 层级来做汇总分析时，这个订单表-产品规格表-产品表这个关系链就能起作用，可以计算比如产品类别的合计销售金额。

此时再回到前面遇到多对多关系时的解决方案，就能理解之所以能通过插入中间表解决，就是因为关系链的存在：学生-学校-任课老师。

### 关系方向

在上图案例中，我们观察到，关系是存在方向的，准确来说这个箭头确定了筛选的方向，比如图中产品规格表和订单表之间一对多的关系是从产品规格表指向了订单表，也就是可以通过产品规格表的字段来筛选分析订单表， **但订单表不能反过来筛选分析规格表。**

一般来说 **不建议使用双向筛选的关系** ，尤其是在复杂数据模型中，双向筛选会导致同一个筛选条件产生多条数据流向，进而产生不同的计算结果。

## 筛选器

<img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie5190pj20fs0cw75n.jpg" width="500px">

PowerBI 有两个地方可以使用筛选器，一个是筛选器栏，一个是切片器，它们的功能是一样的：在计算之前对数据进行过滤。

假设我们现在有公司总的销售额，想要看单个品类，比如数码产品的销售额，就可以把字段"品类"拖拽到筛选器，或者在报表页面新建一个切片器，把字段"品类"拖拽到切片器，然后再选择品类：数码产品，此时页面呈现的数据就是数码产品的销售额。

那在实操中，一般放什么到过滤器里？前面数据建模小节中，我们介绍了维度建模，在分析数据时， **用维度透视事实数据，也就是说，我们一般是要把维度表里的维度放到过滤器中。**

比如前面案例中，订单表是事实表，产品表是维度表，我们要做过滤筛选时，就要把产品表里的维度放到过滤器中，比如按产品类型、按品类对销售订单进行过滤。

## 度量值

度量值是 PowerBI 战斗力的核心，通过它，使用者可以轻松实现许多复杂的计算。

### 什么是度量值？

<img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie61wp8j20gh05g3yr.jpg" width="450px">

<img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie72ruqj209a042t8u.jpg" width="250px">

简单来说度量值是一个计算器，设计好函数公式后，输入指定的数据，返回计算结果。

更形象来说，度量值是一个"便携式的计算盒子"，可以放到不同上下文里，用同样的公式计算出不同的结果。

更准确来说，度量值是一个虚拟字段，它不会固定在某个表里，因此也不会改变数据结构。前面说它是"便携的计算盒子"，是因为它的使用方式是要把它拖拽到不同报表里，呈现计算结果，同时它又随着过滤器的筛选而变化，也可以说它是在与报表交互时才使用的。

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie7k860j20lq0iq410.jpg)

如图，新建一个度量值 [销售额] = sum('订单表'[销售额]) 用于计算「合计」的销售额指标，但是它放到不同类别的表格中，统计的就是不同子类别的合计销售额，而把它单独放出来，就是所有品类的合计销售额。

### 度量值与Excel透视表

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie8dpugj20q20k9dja.jpg)

为了帮助理解度量值，可以拿我们最为熟悉的Excel透视表来作对比：

- 透视表 = 筛选+列+行+值
- 度量值 = 上下文+筛选计算

由这两个公式可以看出，度量值里的上下文可以显性地对应到透视表里的行和列，但是它还有隐形的关系链，筛选器的作用能通过这条关系链传递，所以度量值的上下文具有灵活的定义。

而度量值里的 **筛选计算** 就类似于透视表里的筛选和值，其中值就是公式的计算结果。

## DAX

前面介绍了强大的度量值，那它是如何被设计的呢？这就要看DAX了。

### 什么是DAX

DAX 的全称叫 Data Analysis Expressions，中文翻译过来就是数据分析表达式，也可以理解成是一种编程语法，我们就是通过它来设计度量值。

同样为了便于理解，可以对应到 Excel 来学习：**DAX之于PowerBI，就类似Excel函数之于Excel**

### 如何学习DAX

有些同学学习 PowerBI 的时候，抱着 DAX 圣经（《DAX权威指南》）就想啃，但是这书很厚内容很多太难完成，导致学习热情渐逝。其实上，对于处在从 0 到 1 阶段的初学者，学习还是有"捷径"的，那就是 **以终为始：工具的作用在于解决业务问题，所以需要满足什么业务需求，就学习对应的功能、函数即可** 。

具体如何做呢？

1、**对照Excel学DAX**

作为同为微软旗下的产品，DAX在设计之初就尽量地向Excel函数靠近，降低用户使用成本。因此，对于常用的函数方法，可以对比在Excel中的使用来理解。

2、**学习常用DAX函数**

按照以终为始的方法，其实业务中真正常用的函数不多，可以 **以做项目的思路，做几个完整的项目，遇到不懂的再查询，这样项目完成后，常用的函数就学到手了。**

在实践中，即使常用的函数也有忘记的时候，但是不用担心，PowerBI写度量值的公示栏会每个函数都有参数提示。这样能降低DAX函数的学习成本，可以让我们把更多精力放在度量值的设计上。

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie8xzb6j20jo056t97.jpg)

3、**尝试写复杂业务逻辑的度量值**

度量值是 PowerBI 的精髓，想要掌握 PowerBI 就必须先掌握度量值的设计。建议可以 **借助复杂的业务需求来专研**DAX **的解决方案，由此为起点，探索上下文、数据建模、关系等的协同作用** 。

### 常用的函数

#### Filter

注释：筛选器函数，返回经过表达式过滤后的 **表**
语法：`Filter(<表>, <表达式>)`

#### Calculate

Calculate是DAX中最重要的计算函数，常与filter搭配使用。

注释：在由筛选器修改后的上下文中计算表达式
语法：`Calculate(<表达式>,<filter1>,<fiter2>...)`

#### 聚合函数

与SQL中的聚合函数（Groupby Function）是一样的概念，例如用于 EDA 描述统计的相关函数：合计 Sum、平均值 Average、计数 Count、中位数 Median、分位数 Percentile，它们的作用、语法与Excel中相似。

在实践中，常与Calcuate、Filter搭配使用，实现不同场景下的指标计算。

在上文介绍度量值时，我们说 `[销售额] = sum('订单表'[销售额])` 可以单独放在不同上下文中，计算不同指标，例如

```sql
[家具销售额] = Calculate([销售额], 
              Filter('产品表', '产品表'[类别]="家具"))
```

当然这个度量值等同于

```sql
[家具销售额] = Calculate(sum('订单表'[销售额]), 
              Filter('产品表', '产品表'[类别]="家具"))
```

用于计算家具类别对应订单的销售总额。

在介绍Calculate函数时，它的语法中有多个filter，也就是说它是可以加多个筛选器的，例如：

```sql
[2月家具销售额] =  Calculate([销售额], 
                  Filter('产品表', '产品表'[类别]="家具"), 
                  Filter('日期表', '日期表'[月份]=2)
```

#### 逻辑函数

与Excel中相似，DAX中同样有用于判断的逻辑函数：IF、IFERROR等，因为它们在Excel中同样非常常见， 就不做深入介绍。这里介绍一个比IF效率更高的逻辑函数SWITCH。

#### Switch

注释：用于**条件判断**
语法：`Switch (<表达式>, <值1>, <结果1> , <值2>, <结果2>, ..., <Else>)`
示例：按订单金额划分区间：

```
金额区间  = SWITCH ( TRUE(),
'订单表'[销售额]<=1000, "(0,1000]" ,
'订单表'[销售额] <=2000, "(1000,2000]" ,
'订单表'[销售额] <=3000, "(2000,3000]" , "3000元以上"
)
```

#### 时间函数

顾名思义，时间函数主要用于处理时间、日期数据，例如在Excel里的Date函数，生成日期类型的数据；在Dax中，同样如此。

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iie9b70oj20jm02mq3b.jpg)

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iieae6jij20f0043aad.jpg)

再例如常见的计算两个日期间隔天数的函数，在Excel中是DATEDIF，在Dax中是DATEDIFF

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iieb62ptj20hx02ogm4.jpg)

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iiebm029j20la03u74v.jpg)

#### 日期表

项目实践中，通常需要新建 **「日期维度表」** ，并在数据建模中，把它（日期）与订单表（订单日期）等事实表连接，用于时间维度的筛选、分析。

日期表可以使用以下Dax语句直接生成：

```sql
日期表 = 
----------------------------------------------------------------
制作日期表的相关参数，可根据需要修改
VAR YearStart = 2019    //起始年度
VAR YearEnd = 2021      //结束年度
VAR WeekNumberType = 2
    // WEEKNUM第二个参数类型，控制每周的开始时间，返回此周在一年中的编号
    // 1，一周从星期日开始 
    // 2，一周从星期一开始 
VAR WeekDayType = 2       
    // WEEKDAY第二个参数类型，控制每周的开始时间，返回周几的编号
    // 1，一周从星期日 (1) 开始，到星期六 (7) 结束，编号 1 到 7
    // 2，一周从星期一 (1) 开始，到星期日 (7) 结束，编号 1 到 7
    // 3，一周从星期一 (0) 开始，到星期日 (6) 结束，编号 0 到 6
-----------------------------------------------------------------
RETURN
GENERATE (
    CALENDAR( DATE( YearStart , 1 , 1 ) , DATE( YearEnd , 12 , 31 ) ),
    VAR Year = YEAR ( [Date] )
    VAR Month = MONTH ( [Date] )
    VAR Quarter = QUARTER( [Date] )
    VAR Day = DAY( [Date] )
    VAR YearMonth = Year * 100 + Month
    VAR Weekday = WEEKDAY( [Date] , WeekDayType ) 
    VAR WeekOfYear = WEEKNUM( [Date] , WeekNumberType )
    RETURN ROW (
        "年" , Year ,
        "季" , Quarter ,
        "月" , Month ,
        "日" , Day ,
        "年度名称" , "Y" & Year ,
        "季度名称" , "Q" & Quarter ,
        "年度季度", Year & "Q" & Quarter ,
        "年季编号" , ( Year - YearStart )*4 + Quarter,
        "月份名称", FORMAT ( [Date], "OOOO" ) ,
        "英文月份", FORMAT ( [Date], "MMM" ) ,
        "年度月份" , YearMonth ,
        "年月编号" , ( Year - YearStart )*12 + Month,
        "年度第几日" , INT( [Date] - DATE( Year , 1 , 1 ) + 1 ),      
        "星期编号" , Weekday ,
        "星期名称" , FORMAT( [Date] , "AAAA" ) ,
        "星期英文" , FORMAT( [Date] , "DDD" ) ,  
        "年度第几周" , WeekOfYear ,
        "周编号", "W" & RIGHT( 0 & WeekOfYear , 2 ) ,
        "年周" , Year & "W" & RIGHT( 0 & WeekOfYear , 2 ) ,
        "日期编码" , Year * 10000 + Month * 100 + Day
    )
)
```

其中，可以把参数根据事实表中的时间范围进行调整，以生成符合分析范围的日期表。

#### 时间智能函数

在时间函数中，有一种类型叫「时间智能函数」，它可以根据当前时间 **返回不同的相对时间结果** ，例如当前是2022年6月1日，SAMEPERIODLASTYEAR可以返回2021年6月1日。由此可见，时间智能函数可以极大简化语法复杂度，尤其适用在业务KPI跟踪类型的报表。

那时间智能函数与普通的时间函数有什么区别呢？

- 普通时间函数依赖当前行上下文，一般作为新建列使用，比如YEAR函数，提取日期列的年度；
- 时间智能函数会 **重置上下文** ，一般新建度量值时使用， **可以快速移动到指定区间**

时间智能函数计算返回的结果有两种，一种是返回一个期间，另一种是返回期间并计算。

##### 返回期间的时间智能函数

这类函数很简单，使用一个日期参数就可以返回对应的时间期间，一般用在CALCULATE中的FILTER。

比如

```sql
[同期销售额] =  CALCULATE([销售额],SAMEPERIODLASTYEAR('日期表'[日期]))
```

该度量值使用了时间智能函数SAMEPERIODLASTYEAR，返回了去年同期的日期作为上下文计算销售额。

再例如DATESYTD函数，返回年初至今的日期「表」，也就是返回一个期间，利用它可以计算业务常见的KPI指标：

```sql
[本年累计销售额] = CALCULATE([销售额], DATESYTD('日期表'[日期]))
```



##### 返回期间并计算的时间智能函数

此类函数除了返回日期外，还能执行运算。

例如上述本年累计销售额指标，可以使用TOTALYTD函数（返回年初至今的表达式的值）简化：

```sql
[本年累计销售额]=TOTALYTD（[销售额],'日期表'[日期]）
```

## Dax返回「值」与「表」

Dax返回的结果有两种，一种是单个的**值** ，一种是**表** ，按这个维度可以把函数类型划分为：值函数、表函数。

值函数与我们在Excel中使用的函数相似（例如聚合函数），比较好理解；而表函数则是Dax特有的语法，例如上文中的时间智能函数，我们说它们返回的至少是一个时间期间上下文，实际上它们就是表函数，返回的结果就是表。

PowerBI中，在"新建度量值"、"新建列"，"新建表"中会使用到DAX，而前两者需要的是值函数，最后的"新建表"功能需要用到表函数。

![图片](https://tva1.sinaimg.cn/large/e6c9d24ely1h3iieck22hj207l030wee.jpg)

在值函数中，也可能会用到表函数，例如经典的 Calculate+Filter 组合，在这里，表函数的作用主要是帮助建立业务指标所需的上下文场景。
